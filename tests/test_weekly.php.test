<?php
use PHPUnit\Framework\TestCase;

class test_weekly extends TestCase
{
    private static $phpFileContent;
    
    private static function remove_comments($string) {
        $pattern = '/(?:(?:\/\*(?:[^*]|(?:\*+[^*\/]))*\*+\/)|(?:(?<!\:|\\\|\')\/\/.*))/';
        return preg_replace($pattern, '', $string);
    }

    public static function setUpBeforeClass(): void
    {
        // Read the PHP file content
        $filePath = __DIR__ . '/../src/weekly/api/index.php';
        if (!file_exists($filePath)) {
            throw new Exception("File not found: {$filePath}");
        }
        self::$phpFileContent = self::remove_comments(file_get_contents($filePath));
    }
    
    /**
     * @group TASK3301
     */
    public function testSessionStartExists()
    {
        $this->assertStringContainsString(
            'session_start()',
            self::$phpFileContent,
            'session_start() function call should exist in the PHP file'
        );
    }

    /**
     * @group TASK3302
     */
    public function testHeaderFunctionExists()
    {
        $this->assertStringContainsString(
            'header(',
            self::$phpFileContent,
            'header() function call should exist in the PHP file'
        );
    }

    /**
     * @group TASK3303
     */
    public function testJsonHeaderExists()
    {
        $this->assertStringContainsString(
            'application/json',
            self::$phpFileContent,
            'Content-Type: application/json should be set in headers'
        );
    }

    /**
     * @group TASK3304
     */
    public function testServerSuperglobalExists()
    {
        $this->assertStringContainsString(
            '$_SERVER',
            self::$phpFileContent,
            '$_SERVER superglobal should be used to check request method'
        );
    }

     /**
     * @group TASK3305
     */
    public function testRequestMethodCheckExists()
    {
        $this->assertStringContainsString(
            'REQUEST_METHOD',
            self::$phpFileContent,
            'REQUEST_METHOD should be checked'
        );
    }

     /**
     * @group TASK3306
     */
    public function testFileGetContentsExists()
    {
        $this->assertStringContainsString(
            'file_get_contents(',
            self::$phpFileContent,
            'file_get_contents() should be used to read request body'
        );
    }

     /**
     * @group TASK3307
     */
    public function testPhpInputExists()
    {
        $this->assertStringContainsString(
            'php://input',
            self::$phpFileContent,
            'php://input should be used to get raw POST data'
        );
    }

     /**
     * @group TASK3308
     */
    public function testJsonDecodeExists()
    {
        $this->assertStringContainsString(
            'json_decode(',
            self::$phpFileContent,
            'json_decode() should be used to parse JSON data'
        );
    }

     /**
     * @group TASK3309
     */
    public function testFilterVarExists()
    {
        $this->assertStringContainsString(
            'filter_var(',
            self::$phpFileContent,
            'filter_var() should be used for server-side validation'
        );
    }

     /**
     * @group TASK3310
     */
    public function testFilterValidateEmailExists()
    {
        $this->assertStringContainsString(
            'FILTER_VALIDATE_EMAIL',
            self::$phpFileContent,
            'FILTER_VALIDATE_EMAIL should be used for email validation'
        );
    }

     /**
     * @group TASK3311
     */
    public function testPdoPrepareExists()
    {
        $this->assertStringContainsString(
            'prepare(',
            self::$phpFileContent,
            'PDO prepare() method should be used for prepared statements'
        );
    }

     /**
     * @group TASK3312
     */
    public function testPdoExecuteExists()
    {
        $this->assertStringContainsString(
            'execute(',
            self::$phpFileContent,
            'PDO execute() method should be called to run prepared statement'
        );
    }

     /**
     * @group TASK3313
     */
    public function testPdoFetchExists()
    {
        $this->assertStringContainsString(
            'fetch(',
            self::$phpFileContent,
            'PDO fetch() method should be used to get user data'
        );
    }

     /**
     * @group TASK3314
     */
    public function testPasswordVerifyExists()
    {
        $this->assertStringContainsString(
            'password_verify(',
            self::$phpFileContent,
            'password_verify() should be used to check password'
        );
    }

     /**
     * @group TASK3315
     */
    public function testSessionVariableExists()
    {
        $this->assertStringContainsString(
            '$_SESSION',
            self::$phpFileContent,
            '$_SESSION should be used to store user data'
        );
    }

     /**
     * @group TASK3316
     */
    public function testJsonEncodeExists()
    {
        $this->assertStringContainsString(
            'json_encode(',
            self::$phpFileContent,
            'json_encode() should be used to create JSON responses'
        );
    }

     /**
     * @group TASK3317
     */
    public function testTryCatchExists()
    {
        $this->assertStringContainsString(
            'try',
            self::$phpFileContent,
            'try-catch block should be used for error handling'
        );
        
        $this->assertStringContainsString(
            'catch',
            self::$phpFileContent,
            'catch block should be used to handle exceptions'
        );
    }

     /**
     * @group TASK3318
     */
    public function testPdoExceptionExists()
    {
        $this->assertStringContainsString(
            'PDOException',
            self::$phpFileContent,
            'PDOException should be caught in catch block'
        );
    }
}
